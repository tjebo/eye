---
title: eye
output: github_document
bibliography: eye.bib
link-citations: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
library(eye)
```

See more with *eye*. 

*eye* is dedicated to facilitate ophthalmic research.</br>
Its core functions [`blink()`](#blink), [`eyes()`](#eyes), [`myop()`](#myop), and [`va()`](#va) help with very common tasks:

- Counting patients and eyes
- Visual acuity and intraocular pressure: Shape data and analyze!
- Conversion of visual acuity notations.

*eye* contains a well curated [real life data set](#amd-data) and some functions beyond ophtalmology, which could make your data analysis a tiny bit more convenient.

Finally, eye comes with [`geom_trail()`](#geom_trail) for some nice trail graphs. 

# Features
## Pure ophthalmology
- [Perceive your data in a blink of an eye](#blink)
- [Easy count of patients and eyes](#eyes)
- [Conversion of visual acuity notations](#va)
- [Make your eye data long](#myop)

### AMD data 
- Anonymised [real life data from a large cohort](https://datadryad.org/stash/dataset/doi:10.5061/dryad.97r9289) of patients with treatment-naive neovascular age-related macular degeneration (AMD) who received intravitreal anti-VEGF therapy in Moorfields Eye Hospital, London, UK. 
- To reference this data in your publication, please kindly cite the corresponding publication.[@fasler] 

## Beyond the eye

### Convenience functions: 
- [Insight: get common summary statistics](#insight)
- [Calculate age](#age)
- [Conveniently save a data frame to csv](#csv)

### Catch eyes - ggplot2 extensions 
- [geom_trail: A base plot type = "b" equivalent for ggplot2](#geom_trail)

# Install eye
Currently only on github. 
```{r, eval=FALSE}
# for the development version 
devtools::install_github("tjebo/eye")
```

# Examples
## Pure eye stuff - core eye functions 
### blink
### eyes
Count patient and eyes [source](https://github.com/tjebo/eye/blob/master/R/eyes.R)
```{r eyes}
eyes(amd)
```

### va
Visual acuity notation conversion ([source](https://github.com/tjebo/eye/blob/master/R/va.R)). Based on conversion tables, formulas and findings from [@bach] and [@gregori].
```{r va, warning=FALSE, eval = FALSE, message=FALSE, results='hide'}
# TBC
```

### myop
Make your data long ("myopic"). [source](https://github.com/tjebo/eye/blob/master/R/myop.R)
```{r myop, echo=FALSE}
set.seed(42)
iop_wide <- data.frame(id = letters[1:3], r = sample(11:13), l = sample(14:16))
```
```{r myop2}
#wide data
iop_wide

# Make it long
iop_long <- myop(iop_wide)
iop_long
```
Often enough, there are right eye / left eye columns for more than one variable, e.g., for both IOP and VA. `myop` helps you clean this mess. 
```{r, echo=FALSE}
messy_df <- data.frame(id = letters[1:3], iop_r = sample(11:13), iop_l = sample(11:13), va_r = sample(41:43), va_l = sample(41:43))
```
```{r myop two vars}
messy_df

#myop will detect IOP and VA columns automatically

clean_df <- myop(messy_df)
clean_df
```

## Beyond the eye
### insight
Show common statistics
```{r stats, warning=FALSE, message=FALSE}
amd_unq <- amd[!duplicated(amd$Id),]

insight(amd_unq[c("BaselineAge", "VA_ETDRS_Letters", "FollowupDays")])
```

### age
 - Calculate age in years, as [periods or durations](https://lubridate.tidyverse.org/articles/lubridate.html#time-intervals)
 - If only the start date given, calculating the age today.
```{r age, warning=FALSE, message=FALSE}
age("1984-10-16")

dob <-  c("1984-10-16", "2000-01-01")
test_date <-  as.Date(dob) + c(15000, 20000)

age(dob, test_date)
```

### csv
- A convenience wrapper around `write.csv`. Saves a .csv file with the name of the data frame, or with a different name. 
```{r csv, warning=FALSE, message=FALSE, eval = FALSE}
csv(amd)
```

## ggplot2 extensions
### geom_trail
A base plot type = "b" equivalent for ggplot. Works also with text!
```{r trail, message=FALSE}
library(ggplot2)
library(dplyr)
# data preparation
amd_aggr <-
  amd %>%
  group_by(
    age_cut10 = cut_width(BaselineAge, 10),
    days_cut90 = cut_width(FollowupDays, 90, labels = seq(0, 810, 90))
  ) %>%
  summarise(mean_va = mean(VA_ETDRS_Letters)) 

# plot
p <-
  ggplot(amd_aggr, aes(days_cut90, mean_va, color = age_cut10)) +
    theme_classic() +
    labs(x = "Follow up time [Days]", y = "Mean VA [ETDRS letters]", color = "Age strata")

p1 <- p + geom_trail(aes(group = age_cut10))

p2 <- p + geom_trail(aes(group = age_cut10), size = 0) +
          geom_text(aes(label = round(mean_va, 0)), show.legend = FALSE)
```
```{r, eval = FALSE}
p1 

p2
```
```{r, echo=FALSE, out.width="45%"}
p1
p2
```

# Acknowledgements
- Thanks to Siegfried Wagner and Abraham Olvera, for their help with VA conversion
- Thanks to Tim Yap for helping find typos. All remaining typos are entirely his fault.
- Thanks to Hadley Wickham! Many of the functions in my package rely on the `tidyverse` package, but I would never have been able to make this package without his development tools `roxygen2`, `usethis`, `testthis` and `devtools`.

# References


